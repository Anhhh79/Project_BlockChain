<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connection - Charity DApp</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test K·∫øt N·ªëi Blockchain</h1>
    
    <div class="test-box">
        <h3>1. Test Ethers.js</h3>
        <div id="ethersStatus">Ch∆∞a test...</div>
    </div>

    <div class="test-box">
        <h3>2. Test RPC Connection</h3>
        <div id="rpcStatus">Ch∆∞a test...</div>
    </div>

    <div class="test-box">
        <h3>3. Test Contract Address</h3>
        <div id="contractStatus">Ch∆∞a test...</div>
    </div>

    <div class="test-box">
        <h3>4. Test Load Campaigns</h3>
        <button onclick="testLoadCampaigns()">Th·ª≠ Load Campaigns</button>
        <div id="campaignsStatus" style="margin-top: 10px;">Nh·∫•n n√∫t ƒë·ªÉ test...</div>
    </div>

    <div class="test-box">
        <h3>5. Network Info</h3>
        <div id="networkInfo">ƒêang t·∫£i...</div>
    </div>

    <script src="js/ethers.umd.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = '0x7fF862bAD0628e1987037294C3c4bc3d6f367471';
        const RPC_URL = 'https://evmtestnet.confluxrpc.com';
        let provider;
        let contract;

        async function runTests() {
            // Test 1: Ethers.js
            try {
                if (typeof ethers !== 'undefined') {
                    document.getElementById('ethersStatus').innerHTML = 
                        '<div class="status success">‚úì Ethers.js ƒë√£ load: v' + ethers.version + '</div>';
                } else {
                    throw new Error('Ethers.js kh√¥ng load ƒë∆∞·ª£c');
                }
            } catch (error) {
                document.getElementById('ethersStatus').innerHTML = 
                    '<div class="status error">‚úó ' + error.message + '</div>';
            }

            // Test 2: RPC Connection
            try {
                provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                const network = await provider.getNetwork();
                const blockNumber = await provider.getBlockNumber();
                
                document.getElementById('rpcStatus').innerHTML = 
                    '<div class="status success">‚úì K·∫øt n·ªëi RPC th√†nh c√¥ng!<br>' +
                    'Chain ID: ' + network.chainId + '<br>' +
                    'Block Number: ' + blockNumber + '</div>';
                    
                // Network Info
                document.getElementById('networkInfo').innerHTML = `
                    <pre>Network Name: ${network.name}
Chain ID: ${network.chainId}
RPC URL: ${RPC_URL}
Block Number: ${blockNumber}</pre>
                `;
            } catch (error) {
                document.getElementById('rpcStatus').innerHTML = 
                    '<div class="status error">‚úó L·ªói k·∫øt n·ªëi RPC: ' + error.message + '</div>';
                document.getElementById('networkInfo').innerHTML = 
                    '<div class="status error">Kh√¥ng th·ªÉ l·∫•y th√¥ng tin network</div>';
            }

            // Test 3: Contract Address
            try {
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x' || code === '0x0') {
                    throw new Error('Kh√¥ng t√¨m th·∫•y contract t·∫°i ƒë·ªãa ch·ªâ n√†y');
                }
                
                document.getElementById('contractStatus').innerHTML = 
                    '<div class="status success">‚úì Contract t·ªìn t·∫°i!<br>' +
                    'Address: ' + CONTRACT_ADDRESS + '<br>' +
                    'Code Size: ' + code.length + ' bytes</div>';
            } catch (error) {
                document.getElementById('contractStatus').innerHTML = 
                    '<div class="status error">‚úó L·ªói: ' + error.message + '</div>';
            }
        }

        async function testLoadCampaigns() {
            const statusDiv = document.getElementById('campaignsStatus');
            
            try {
                statusDiv.innerHTML = '<div class="status loading">‚è≥ ƒêang load ABI v√† campaigns...</div>';
                
                // Load ABI
                const response = await fetch('charityAbi.json');
                const data = await response.json();
                const abi = data.abi;
                
                // Create contract instance
                contract = new ethers.Contract(CONTRACT_ADDRESS, abi, provider);
                
                // Get next campaign ID
                const nextId = await contract.nextCampaignId();
                statusDiv.innerHTML = '<div class="status loading">T√¨m th·∫•y ' + (nextId - 1) + ' campaigns. ƒêang load...</div>';
                
                // Load all campaigns
                const campaigns = [];
                for (let i = 1; i < nextId; i++) {
                    try {
                        const campaign = await contract.campaigns(i);
                        if (campaign.id.toNumber() !== 0) {
                            campaigns.push({
                                id: campaign.id.toNumber(),
                                title: campaign.title,
                                targetAmount: ethers.utils.formatEther(campaign.targetAmount),
                                collectedAmount: ethers.utils.formatEther(campaign.collectedAmount),
                                active: campaign.active
                            });
                        }
                    } catch (e) {
                        console.warn('Error loading campaign ' + i, e);
                    }
                }
                
                if (campaigns.length === 0) {
                    statusDiv.innerHTML = '<div class="status error">‚ö† Kh√¥ng c√≥ campaigns n√†o. Admin c·∫ßn t·∫°o campaigns tr∆∞·ªõc!</div>';
                } else {
                    let html = '<div class="status success">‚úì Load th√†nh c√¥ng ' + campaigns.length + ' campaigns!</div>';
                    html += '<pre>' + JSON.stringify(campaigns, null, 2) + '</pre>';
                    statusDiv.innerHTML = html;
                }
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚úó L·ªói: ' + error.message + '<br>' + 
                    (error.reason ? 'Reason: ' + error.reason : '') + '</div>';
                console.error('Full error:', error);
            }
        }

        // Run tests on page load
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
